include:
  - project: hslu/shared/devops/cicd
    ref: v5-stable
    file:
      - /templates/common/scripts.yml

default:
  image: $CICD_DEVOPS_PATH/ci-agents/maven:3.9.9-temurin-21

variables:
    MAVEN_CLI_OPTS: "--batch-mode"
    MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
    CICD_VT_DEFAULT_CD_TARGET: secret/edu/apps/bsc-it/swda/cicd/hosts/swda-g99

.javaJob:
  tags:
    - $CICD_RUNNER
  services:
    - name: docker:dind
  before_script:

    # load branch /env specific settings
    - !reference [.plCustomize, script]

    # provide version infos
    - !reference [.versionInfo, script]

.build:
  extends: .javaJob
  script:
      - !reference [.registryPullLogin, script]
      - mvn $MAVEN_CLI_OPTS clean install $MAVEN_OPTS
      - java -jar ./config/jacocoreader-0.0.1.jar ./target/site/jacoco/index.html
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
      paths:
          - target/site/jacoco/jacoco.xml
          - target/*.jar
      reports:
          junit:
              - target/surefire-reports/TEST-*.xml
              - target/failsafe-reports/TEST-*.xml

.coverage:
  extends: .javaJob
  image: $CICD_DEVOPS_PATH/ci-agents/jacoco2cobertura:1.0.9
  script:
      - python /opt/cover2cover.py target/site/jacoco/jacoco.xml $CI_PROJECT_DIR/src/main/java/ > target/site/cobertura.xml
  artifacts:
      reports:
          coverage_report:
              coverage_format: cobertura
              path: target/site/cobertura.xml

.site:
  extends: .javaJob
  script:
      - mvn $MAVEN_CLI_OPTS site $MAVEN_OPTS
  artifacts:
      paths:
          - target/site/
          - target/generated-docs

.depcheck:
  extends: .javaJob
  script:
      - mvn $MAVEN_CLI_OPTS org.owasp:dependency-check-maven:check $MAVEN_OPTS
  artifacts:
      paths:
          - target/dependency-check-report.html

.pages:
  extends: .javaJob
  needs:
      - site
  script:
      - mvn $MAVEN_CLI_OPTS site:stage $MAVEN_OPTS
      - mv target/staging public
      - mv target/generated-docs public/asciidoc
  artifacts:
      paths:
          - public